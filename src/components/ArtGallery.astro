---
const { artItems } = Astro.props;
---
<section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="art-gallery">
  {artItems.map(art => (
    <div class="relative group">
      <img src={art.data.heroImage} alt={art.data.name} class="w-full h-auto object-contain shadow-lg cursor-pointer art-image" loading="lazy" data-art={JSON.stringify(art.data)} />
      <div class="mt-2">
        <h2 class="text-xl font-semibold">{art.data.name}</h2>
        {art.data.subtitle && <p class="text-sm italic text-light-blue">{art.data.subtitle}</p>}
        <p class="text-xs text-gray-400 mt-1">
          {art.data.dimensions}
          <span class="mx-2">•</span>
          <a href="#" class="text-gold hover:underline view-details" data-art={JSON.stringify(art.data)}>View details</a>
        </p>
      </div>
    </div>
  ))}
</section>

<div id="softbox" class="fixed inset-0 z-50 hidden overflow-y-auto" style="background-color: rgba(5, 12, 25, 0.98);">
  
  <!-- Close button - only on desktop, top of right column -->
  <button class="hidden lg:block fixed top-2 right-4 text-gold text-5xl hover:opacity-75 leading-none z-10" id="softbox-close">&times;</button>
  
  <!-- Left column: FIXED position, doesn't scroll -->
  <div class="hidden lg:flex lg:fixed lg:left-0 lg:top-0 lg:w-3/4 lg:h-full flex-col p-4">
    <!-- Main image container -->
    <div class="flex-1 flex items-center justify-center min-h-0">
      <img id="softbox-img" src="" alt="" class="max-w-full max-h-full object-contain" />
    </div>
    
    <!-- Thumbnail gallery -->
    <div id="thumbnail-container" class="flex gap-2 justify-center overflow-x-auto py-2 px-2 hidden flex-shrink-0" style="scroll-snap-type: x mandatory;">
    </div>
  </div>
  
  <!-- Mobile: Image at top (scrolls with page) -->
  <div class="lg:hidden px-2">
    <img id="softbox-img-mobile" src="" alt="" class="max-w-full object-contain mx-auto block" />
    <div id="thumbnail-container-mobile" class="flex gap-2 justify-start overflow-x-auto mt-1 hidden" style="scroll-snap-type: x mandatory;">
    </div>
  </div>
  
  <!-- Right column: Title/Description - scrolls with browser -->
  <div class="px-4 pt-2 pb-4 lg:p-4 lg:ml-[75%]">
    <div>
      <h2 class="text-xl font-semibold text-white" id="softbox-name"></h2>
      <p class="text-sm italic text-light-blue" id="softbox-subtitle"></p>
      <p class="text-xs text-gray-400 mt-1 mb-4">
        <span id="softbox-medium"></span> • <span id="softbox-dimensions"></span> • <span id="softbox-year"></span>
      </p>
    </div>
    <p id="softbox-description" class="text-white text-sm leading-relaxed text-justify hidden"></p>
  </div>
</div>

<script>
  // Configuration: Change this value to adjust the border width around the main image (in pixels)
  const IMAGE_BORDER_WIDTH = 20; // Set to 0 for no border
  
  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll('.art-image');
    const softbox = document.getElementById('softbox');
    const closeBtn = document.getElementById('softbox-close');
    const img = document.getElementById('softbox-img');
    const imgMobile = document.getElementById('softbox-img-mobile');
    const name = document.getElementById('softbox-name');
    const subtitle = document.getElementById('softbox-subtitle');
    const medium = document.getElementById('softbox-medium');
    const dimensions = document.getElementById('softbox-dimensions');
    const year = document.getElementById('softbox-year');
    const thumbnailContainer = document.getElementById('thumbnail-container');
    const thumbnailContainerMobile = document.getElementById('thumbnail-container-mobile');
    const description = document.getElementById('softbox-description');

    // Apply border to main image (desktop only)
    if (IMAGE_BORDER_WIDTH > 0) {
      img.style.border = `${IMAGE_BORDER_WIDTH}px solid white`;
      // Smaller border on mobile
      imgMobile.style.border = `8px solid white`;
    }

    let currentGallery = [];
    let currentIndex = 0;
    let currentSlug = '';

    function updateImage(index) {
      currentIndex = index;
      img.src = currentGallery[currentIndex];
      imgMobile.src = currentGallery[currentIndex];
      
      // Update thumbnail active state (both containers)
      [thumbnailContainer, thumbnailContainerMobile].forEach(container => {
        const thumbnails = container.querySelectorAll('img');
        thumbnails.forEach((thumb, i) => {
          if (i === currentIndex) {
            thumb.classList.add('border-4', 'border-white');
            thumb.classList.remove('opacity-60');
          } else {
            thumb.classList.remove('border-4', 'border-white');
            thumb.classList.add('opacity-60');
          }
        });
      });
    }

    function openSoftbox(data, updateUrl = true) {
      currentGallery = [data.heroImage];
      if (data.galleryImages && data.galleryImages.length > 0) {
        currentGallery = currentGallery.concat(data.galleryImages);
      }
      currentIndex = 0;
      currentSlug = data.slug || '';
      
      img.src = currentGallery[0];
      img.alt = data.name;
      imgMobile.src = currentGallery[0];
      imgMobile.alt = data.name;
      name.textContent = data.name;
      subtitle.textContent = data.subtitle || '';
      medium.textContent = data.medium;
      dimensions.textContent = data.dimensions;
      year.textContent = data.year;
      
      // Handle description
      if (data.description) {
        description.textContent = data.description;
        description.classList.remove('hidden');
      } else {
        description.classList.add('hidden');
      }
      
      // Build thumbnails for both desktop and mobile
      thumbnailContainer.innerHTML = '';
      thumbnailContainerMobile.innerHTML = '';
      if (currentGallery.length > 1) {
        currentGallery.forEach((imgSrc, index) => {
          // Desktop thumbnail
          const thumb = document.createElement('img');
          thumb.src = imgSrc;
          thumb.className = 'h-20 w-auto object-cover cursor-pointer hover:opacity-100';
          if (index === 0) {
            thumb.classList.add('border-4', 'border-white');
          } else {
            thumb.classList.add('opacity-60');
          }
          thumb.onclick = () => updateImage(index);
          thumbnailContainer.appendChild(thumb);
          
          // Mobile thumbnail
          const thumbMobile = document.createElement('img');
          thumbMobile.src = imgSrc;
          thumbMobile.className = 'h-16 w-auto object-cover cursor-pointer hover:opacity-100';
          if (index === 0) {
            thumbMobile.classList.add('border-4', 'border-white');
          } else {
            thumbMobile.classList.add('opacity-60');
          }
          thumbMobile.onclick = () => updateImage(index);
          thumbnailContainerMobile.appendChild(thumbMobile);
        });
        thumbnailContainer.classList.remove('hidden');
        thumbnailContainerMobile.classList.remove('hidden');
      } else {
        thumbnailContainer.classList.add('hidden');
        thumbnailContainerMobile.classList.add('hidden');
      }
      
      softbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Hide body scrollbar
      
      // Update URL hash for shareable links
      if (updateUrl && currentSlug) {
        history.pushState({ softboxOpen: true, slug: currentSlug }, '', '#art=' + currentSlug);
      } else {
        history.pushState({ softboxOpen: true }, '');
      }
    }

    function closeSoftbox() {
      softbox.classList.add('hidden');
      document.body.style.overflow = ''; // Restore body scrollbar
      // Remove hash from URL
      if (window.location.hash) {
        history.pushState({}, '', window.location.pathname);
      }
    }

    // Handle browser back button
    window.addEventListener('popstate', (e) => {
      // Check if we should open an artwork from hash
      const hash = window.location.hash;
      if (hash && hash.startsWith('#art=')) {
        const slug = hash.replace('#art=', '');
        const artImage = document.querySelector(`.art-image[data-art*='"slug":"${slug}"']`);
        if (artImage) {
          const data = JSON.parse(artImage.getAttribute('data-art'));
          openSoftbox(data, false);
          return;
        }
      }
      // Otherwise close if open
      if (!softbox.classList.contains('hidden')) {
        softbox.classList.add('hidden');
      }
    });

    // Check URL hash on page load to open artwork directly
    function checkHashOnLoad() {
      const hash = window.location.hash;
      if (hash && hash.startsWith('#art=')) {
        const slug = hash.replace('#art=', '');
        const artImage = document.querySelector(`.art-image[data-art*='"slug":"${slug}"']`);
        if (artImage) {
          const data = JSON.parse(artImage.getAttribute('data-art'));
          openSoftbox(data, false);
        }
      }
    }
    checkHashOnLoad();

    images.forEach(image => {
      image.onclick = () => {
        const data = JSON.parse(image.getAttribute('data-art'));
        openSoftbox(data);
      };
    });

    document.querySelectorAll('.view-details').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        const data = JSON.parse(link.getAttribute('data-art'));
        openSoftbox(data);
      };
    });

    closeBtn.onclick = () => {
      closeSoftbox();
    };
    
    // Close softbox if click on background
    softbox.addEventListener('click', (e) => {
      if (e.target === softbox || e.target.classList.contains('softbox-content')) {
        closeSoftbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!softbox.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
          updateImage(currentIndex - 1);
        } else if (e.key === 'ArrowRight' && currentIndex < currentGallery.length - 1) {
          updateImage(currentIndex + 1);
        } else if (e.key === 'Escape') {
          closeSoftbox();
        }
      }
    });

    // Touch swipe navigation
    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 50;

    // Desktop image touch
    img.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    img.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const swipeDistance = touchEndX - touchStartX;
      
      if (Math.abs(swipeDistance) > minSwipeDistance) {
        if (swipeDistance < 0 && currentIndex < currentGallery.length - 1) {
          updateImage(currentIndex + 1);
        } else if (swipeDistance > 0 && currentIndex > 0) {
          updateImage(currentIndex - 1);
        }
      }
    }, { passive: true });

    // Mobile image touch
    imgMobile.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    imgMobile.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const swipeDistance = touchEndX - touchStartX;
      
      if (Math.abs(swipeDistance) > minSwipeDistance) {
        if (swipeDistance < 0 && currentIndex < currentGallery.length - 1) {
          updateImage(currentIndex + 1);
        } else if (swipeDistance > 0 && currentIndex > 0) {
          updateImage(currentIndex - 1);
        }
      }
    }, { passive: true });
  });
</script>
